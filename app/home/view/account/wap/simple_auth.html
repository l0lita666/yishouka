{include file="layout/wap/tou2" /}
<!-- 确保页面编码正确 -->
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<div class="myheader" id="myheader">
    <header class="header header-default">
        <button class="btn btn-back fl" type="button" onclick="javascript:history.back(-1);">
            <i class="iconfont iconfont-back"></i>
        </button>
        <div class="header-title">
            <h1 class="title">实名认证</h1>
        </div>
    </header>
</div>

<div class="mycontent" id="mycontent">
    <!-- 步骤指示器 -->
    <div class="auth-steps-mobile">
        <div class="step-item active" data-step="1">
            <div class="step-number">1</div>
            <div class="step-text">填写信息</div>
        </div>
        <div class="step-item" data-step="2">
            <div class="step-number">2</div>
            <div class="step-text">签署承诺书</div>
        </div>
        <div class="step-item" data-step="3">
            <div class="step-number">3</div>
            <div class="step-text">意愿认证</div>
        </div>
    </div>

    <form id="simpleAuthForm" method="post" action="{:url('home/SimpleAuth/index')}">
        <input type="hidden" name="signature" id="signatureInput" value="">
        <!-- 新增：给JS使用的隐藏手机号，避免取值报错 -->
        <input type="hidden" id="mobile" name="mobile" value="{$user.mobile|default=''}">

        <!-- 步骤1: 填写个人信息 -->
        <div class="auth-step-content" id="step1">
            <div class="card">
                <div class="cell">
                    <div class="cell-hd">
                        <label class="control-label">真实姓名</label>
                    </div>
                    <div class="cell-bd">
                        <input type="text" class="form-control" id="username" name="username" value="{$da.name|default=''}" null="请输入真实姓名" placeholder="请输入真实姓名" reg="[\u4e00-\u9fa5]{2,10}" data-input="clear">
                    </div>
                </div>
                <div class="cell">
                    <div class="cell-hd">
                        <label class="control-label">身份证号</label>
                    </div>
                    <div class="cell-bd">
                        <input type="text" class="form-control" id="idcard" name="idcard" value="{$da.idcard|default=''}" null="请输入正确的身份证号码" placeholder="请输入您的身份证号码" reg="^(\d{15}$|^\d{18}$|^\d{17}(\d|X|x))$" data-input="clear">
                    </div>
                </div>
            </div>

            <!-- 说明文字 -->
            <div class="auth-description-mobile">
                <p>请输入与您真实的姓名和身份证号，需要通过人脸识别验证是否与本人一致</p>
            </div>

            <!-- 同意条款 -->
            <div class="card">
                <div class="cell">
                    <div class="cell-bd">
                        <label class="agreement-checkbox-mobile">
                            <input type="checkbox" id="agree_step1" name="agree_step1">
                            <span class="checkmark-mobile"></span>
                            <span class="agreement-text-mobile">您需对注册信息的真实性、合法性、有效性承担全部责任；易收卡账户仅限本人使用，不得冒用他人信息进行注册，否则本平台有权立即停止向您提供服务并保留追究法律责任的权利</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="myaction-wrapper">
                <div class="myaction">
                    <div class="btn-group">
                        <button class="btn btn-primary btn-auth-start-mobile" type="button" onclick="nextStep(2)">开始认证</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 步骤2: 签署承诺书 -->
        <div class="auth-step-content" id="step2" style="display:none;">
            <div class="commitment-mobile">
                <!-- 承诺书内容 -->
                <div class="document-mobile">
                    <div class="document-header-mobile">
                        <h4>用户承诺书</h4>
                        <div class="document-watermark-mobile">Forbidden Copy</div>
                    </div>
                    <div class="document-content-mobile">
                        <p class="document-intro-mobile">本人确认并承诺：</p>
                        <ol class="commitment-list-mobile">
                            <li>本人自愿注册易收卡平台，保证提供的身份信息真实、完整，不存在冒用他人身份信息的情况，不会将本人实名账户出租、出售或出借给他人使用。</li>
                            <li>如第三方（包括但不限于司法机关、行政机关等）就本人在易收卡平台销售卡片相关事宜向易收卡平台投诉或举报存在违法违规行为，本人承诺积极配合易收卡平台及相关部门进行调查，包括但不限于提供本人身份信息、交易记录等。</li>
                            <li>本人保证所销售的所有充值卡、加油卡、游戏点卡等卡片的来源真实、合法、合规，并承担相应的法律责任。</li>
                            <li>本人承诺不会利用易收卡平台及其API功能进行洗钱、掩饰犯罪所得、电信诈骗、盗窃、非法套现等违法犯罪活动。</li>
                            <li>本人自愿接受易收卡平台及相关监管部门的监督。</li>
                            <li>因本人所售卡片存在违法违规问题导致的一切损失或不良后果（包括但不限于银行账户被冻结、第三方投诉、政府部门调查、平台运营受影响等），本人承担全部法律责任，并同意全额赔偿易收卡平台因此遭受的所有损失（包括但不限于平台停机损失、银行利息损失、法律费用、配合调查产生的差旅费等）。</li>
                        </ol>
                        <p class="document-conclusion-mobile">本人或本公司确认并知晓以上内容并保证按上述条款执行。</p>

                        <!-- 承诺人信息 -->
                        <div class="signatory-info-mobile">
                            <div class="signatory-row-mobile">
                                <span class="signatory-label-mobile">承诺人/公司：</span>
                                <span class="signatory-value-mobile" id="signatory_name">待填写</span>
                            </div>
                            <div class="signatory-row-mobile">
                                <span class="signatory-label-mobile">承诺人身份证号：</span>
                                <span class="signatory-value-mobile" id="signatory_idcard">待填写</span>
                            </div>
                            <div class="signatory-row-mobile">
                                <span class="signatory-label-mobile">签署日期：</span>
                                <span class="signatory-value-mobile" id="signatory_date">待填写</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 签署区域 -->
                <div class="signature-mobile">
                    <div class="signature-header-mobile">
                        <span class="signature-label-mobile">签署区域 1/1</span>
                    </div>
                    <div class="signature-container-mobile">
                        <canvas id="signatureCanvas" width="300" height="150"></canvas>
                    </div>
                    <div class="signature-actions-mobile">
                        <button type="button" class="btn btn-outline-secondary-mobile" onclick="clearSignature()">清除重签</button>
                    </div>
                </div>

                <!-- 同意条款 -->
                <div class="agreement-mobile">
                    <label class="agreement-checkbox-mobile">
                        <input type="checkbox" id="agree_terms" name="agree_terms">
                        <span class="checkmark-mobile"></span>
                        <span class="agreement-text-mobile">我已阅读并同意上述承诺书内容</span>
                    </label>
                </div>
            </div>

            <div class="myaction-wrapper">
                <div class="myaction">
                    <div class="btn-group">
                        <button class="btn btn-default" type="button" onclick="prevStep(1)">上一步</button>
                        <button class="btn btn-primary" type="button" onclick="nextStep(3)">确认签署</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 步骤3: 手机验证和人脸识别 -->
        <div class="auth-step-content" id="step3" style="display:none;">
            <div class="card">
                <!-- 个人信息确认 -->
                <div class="personal-info-section-mobile">
                    <div class="info-title-mobile">请确认您的个人信息</div>
                    <div class="info-card-mobile">
                        <div class="info-item-mobile">
                            <span class="info-label">证件类型：</span>
                            <span class="info-value">居民身份证</span>
                        </div>
                        <div class="info-item-mobile">
                            <span class="info-label">姓名：</span>
                            <span class="info-value" id="summary_name_step3"></span>
                        </div>
                        <div class="info-item-mobile">
                            <span class="info-label">证件号：</span>
                            <span class="info-value" id="summary_idcard_step3"></span>
                        </div>
                        <div class="info-item-mobile">
                            <span class="info-label">手机号：</span>
                            <span class="info-value" id="summary_mobile_step3">{$user.mobile_masked|default=''}</span>
                        </div>
                    </div>
                </div>

                <div class="cell">
                    <div class="cell-hd">
                        <label class="control-label">验证码</label>
                    </div>
                    <div class="cell-bd">
                        <div class="verify-code-input-mobile">
                            <input type="text" class="form-control" id="verify_code" name="verify_code" null="请输入验证码" placeholder="请输入6位验证码" reg="[0-9]{6}" data-input="clear">
                            <button type="button" class="get-code-btn-mobile" onclick="sendVerifyCode()" id="send_code_btn">获取验证码</button>
                        </div>
                    </div>
                </div>
                <div class="cell">
                    <div class="cell-bd">
                        <div class="agreement-section-mobile">
                            <label class="agreement-checkbox-mobile">
                                <input type="checkbox" id="agree_final" name="agree_final">
                                <span class="checkmark"></span>
                                <span class="agreement-text">我已阅读并同意《易收卡用户协议》、《易收卡隐私政策》及《第三方个人信息共享清单》，并已了解相关数据会被传输至服务器中</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="myaction-wrapper">
                <div class="myaction">
                    <div class="btn-group">
                        <button class="btn btn-default" type="button" onclick="prevStep(2)">上一步</button>
                        {:token_field()}
                        <button class="btn btn-success btn-large" type="submit" name="submitAuth" id="submit-btn">开始人脸识别</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
.auth-steps-mobile {
	display: flex;
	justify-content: space-between;
	margin: 20px 0;
	padding: 0 15px;
}

.step-item {
	flex: 1;
	text-align: center;
	position: relative;
}

.step-item:not(:last-child)::after {
	content: '';
	position: absolute;
	top: 15px;
	right: -50%;
	width: 100%;
	height: 2px;
	background: #e9ecef;
	z-index: 1;
}

.step-item.active:not(:last-child)::after {
	background: #007bff;
}

.step-number {
	width: 30px;
	height: 30px;
	border-radius: 50%;
	background: #e9ecef;
	color: #6c757d;
	display: flex;
	align-items: center;
	justify-content: center;
	margin: 0 auto 5px;
	font-weight: bold;
	font-size: 12px;
	position: relative;
	z-index: 2;
}

.step-item.active .step-number {
	background: #007bff;
	color: white;
}

.step-item.completed .step-number {
	background: #28a745;
	color: white;
}

.step-text {
	font-size: 12px;
	color: #6c757d;
}

.step-item.active .step-text {
	color: #007bff;
	font-weight: bold;
}

.commitment-text {
	line-height: 1.6;
	font-size: 14px;
	max-height: 300px;
	overflow-y: auto;
}

.commitment-text ol {
	padding-left: 20px;
}

.commitment-text li {
	margin-bottom: 8px;
}

.signature-area-mobile {
	text-align: center;
}

.signature-actions {
	margin-top: 10px;
}

.auth-summary-mobile {
	background: #f8f9fa;
	padding: 15px;
	border-radius: 5px;
	margin: 15px 0;
	text-align: left;
}

.auth-summary-mobile p {
	margin-bottom: 8px;
	font-size: 14px;
}

.success-icon {
	margin-bottom: 15px;
}

.info-summary-mobile {
	background: #f8f9fa;
	padding: 15px;
	border-radius: 5px;
	margin: 10px 0;
}

.info-summary-mobile p {
	margin-bottom: 8px;
	font-size: 14px;
}

/* 个人信息确认区域样式 */
.personal-info-section-mobile {
	margin: 20px 0;
}

.info-title-mobile {
	font-size: 18px;
	font-weight: 600;
	color: #333;
	margin-bottom: 15px;
	text-align: center;
}

.info-card-mobile {
	background: #fff;
	border: 1px solid #e9ecef;
	border-radius: 8px;
	padding: 20px;
	box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.info-item-mobile {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 12px 0;
	border-bottom: 1px solid #f0f0f0;
	font-size: 16px;
}

.info-item-mobile:last-child {
	border-bottom: none;
}

.info-label {
	font-weight: 500;
	color: #666;
	min-width: 100px;
}

.info-value {
	color: #333;
	flex: 1;
	text-align: right;
	font-weight: 500;
}

/* 验证码区域样式 */
.verify-code-section-mobile {
	margin: 20px 0;
}

.verify-code-input-mobile {
	display: flex;
	align-items: center;
	gap: 10px;
	margin-bottom: 10px;
}

.verify-code-input-mobile input {
	flex: 1;
	padding: 12px 15px;
	border: 1px solid #ddd;
	border-radius: 6px;
	font-size: 16px;
}

.get-code-btn-mobile {
	background: transparent;
	color: #007bff;
	border: none;
	padding: 12px 20px;
	border-radius: 6px;
	cursor: pointer;
	font-size: 14px;
	white-space: nowrap;
}


/* 协议区域样式 */
.agreement-section-mobile {
	margin: 25px 0;
	padding: 20px;
	background: #f8f9fa;
	border-radius: 8px;
	border: 1px solid #e9ecef;
}

.agreement-checkbox-mobile {
	display: flex;
	align-items: flex-start;
	cursor: pointer;
	color: #333;
	line-height: 1.6;
}


/* 通用复选框样式 */
.agreement-checkbox-mobile {
  position: relative;
  padding-left: 24px; /* 预留勾选框位置 */
  cursor: pointer;
  display: inline-block;
  line-height: 1.5;
}

.agreement-checkbox-mobile input[type="checkbox"] {
  position: absolute;
  opacity: 0;
  cursor: pointer;
}

.agreement-checkbox-mobile .checkmark {
  position: absolute;
  top: 2px;
  left: 0;
  height: 16px;
  width: 16px;
  background-color: #fff;
  border: 1px solid #ccc;
  border-radius: 3px;
}

.agreement-checkbox-mobile input[type="checkbox"]:checked ~ .checkmark {
  background-color: #20c997;
  border-color: #20c997;
}

.agreement-checkbox-mobile .checkmark:after {
  content: "";
  position: absolute;
  display: none;
}

.agreement-checkbox-mobile input[type="checkbox"]:checked ~ .checkmark:after {
  display: block;
}

.agreement-checkbox-mobile .checkmark:after {
  left: 5px;
  top: 1px;
  width: 4px;
  height: 8px;
  border: solid white;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
}

.agreement-checkbox-mobile input[type="checkbox"] {
	margin-right: 12px;
	margin-top: 3px;
	transform: scale(1.2);
}

.agreement-text {
	font-size: 14px;
	color: #666;
	flex: 1;
}

/* 按钮区域样式 */
.btn-group {
	display: flex;
	gap: 15px;
	margin-top: 30px;
}

.btn-group .btn {
	flex: 1;
	padding: 15px 20px;
	font-size: 16px;
	font-weight: 600;
	border-radius: 8px;
	border: none;
	cursor: pointer;
	transition: all 0.3s ease;
}

.btn-default {
	background: #f8f9fa;
	color: #6c757d;
	border: 1px solid #dee2e6;
}

.btn-default:hover {
	background: #e9ecef;
	color: #495057;
}

.btn-success {
	background: linear-gradient(to right, #0085fe 0%, #5c4bf6 100%);
	color: white;
}

.btn-success:hover {
	background: linear-gradient(to right, #0085fe 0%, #5c4bf6 100%);
}

.btn-large {
	padding: 18px 25px;
	font-size: 18px;
}

/* 移动端承诺书样式 */
.commitment-mobile {
	background: #fff;
	border-radius: 8px;
	overflow: hidden;
	margin-bottom: 55px;
}

.document-mobile {
	position: relative;
	padding: 20px;
	background: #fff;
	border-bottom: 1px solid #e9ecef;
}

.document-header-mobile {
	text-align: center;
	margin-bottom: 20px;
	position: relative;
}

.document-header-mobile h4 {
	font-size: 20px;
	font-weight: 600;
	color: #333;
	margin: 0;
}

.document-watermark-mobile {
	position: absolute;
	top: 50%;
	left: 50%;
	transform: translate(-50%, -50%) rotate(-45deg);
	font-size: 32px;
	color: rgba(0,0,0,0.05);
	font-weight: bold;
	pointer-events: none;
	z-index: 1;
}

.document-content-mobile {
	position: relative;
	z-index: 2;
	line-height: 1.6;
	color: #333;
	font-size: 14px;
}

.document-intro-mobile {
	font-weight: 600;
	margin-bottom: 15px;
	color: #333;
}

.commitment-list-mobile {
	margin: 15px 0;
	padding-left: 15px;
}

.commitment-list-mobile li {
	margin-bottom: 12px;
	line-height: 1.5;
	color: #555;
}

.document-conclusion-mobile {
	margin-top: 20px;
	font-weight: 600;
	text-align: center;
	color: #333;
}

/* 移动端承诺人信息样式 */
.signatory-info-mobile {
	margin-top: 20px;
	padding: 15px;
	background: #f8f9fa;
	border-radius: 6px;
	border: 1px solid #e9ecef;
}

.signatory-row-mobile {
	display: flex;
	margin-bottom: 10px;
	align-items: center;
}

.signatory-row-mobile:last-child {
	margin-bottom: 0;
}

.signatory-label-mobile {
	font-weight: 600;
	color: #333;
	min-width: 120px;
	margin-right: 8px;
	font-size: 13px;
}

.signatory-value-mobile {
	color: #555;
	flex: 1;
	font-size: 13px;
}

/* 移动端签署区域样式 */
.signature-mobile {
	padding: 20px;
	background: #f8f9fa;
	border-bottom: 1px solid #e9ecef;
}

.signature-header-mobile {
	margin-bottom: 15px;
}

.signature-label-mobile {
	font-size: 12px;
	color: #6c757d;
	background: #e9ecef;
	padding: 6px 12px;
	border-radius: 4px;
	display: inline-block;
}

.signature-container-mobile {
	position: relative;
	text-align: center;
	background: #fff;
	border: 2px dashed #dee2e6;
	border-radius: 8px;
	padding: 15px;
	margin-bottom: 15px;
}

#signatureCanvas {
	border: none;
	cursor: crosshair;
	background: #fff;
	border-radius: 4px;
	width: 100%;
	max-width: 300px;
}


.signature-actions-mobile {
	text-align: center;
}

.btn-outline-secondary-mobile {
	border: 1px solid #6c757d;
	color: #6c757d;
	background: transparent;
	padding: 8px 16px;
	border-radius: 4px;
	font-size: 14px;
}

.btn-outline-secondary-mobile:hover {
	background: #6c757d;
	color: white;
}

/* 移动端同意条款样式 */
.agreement-mobile {
	padding: 15px 20px;
	background: #fff;
}

.agreement-checkbox-mobile {
	display: flex;
	align-items: center;
	cursor: pointer;
	color: #333;
}

.agreement-checkbox-mobile input[type="checkbox"] {
	display: none;
}

.checkmark-mobile {
	width: 18px;
	height: 18px;
	border: 2px solid #dee2e6;
	border-radius: 4px;
	margin-right: 10px;
	position: relative;
	transition: all 0.3s ease;
}

.agreement-checkbox-mobile input[type="checkbox"]:checked + .checkmark-mobile {
	background: #20c997;
	border-color: #20c997;
}

.agreement-checkbox-mobile input[type="checkbox"]:checked + .checkmark-mobile::after {
	content: '✓';
	position: absolute;
	top: 50%;
	left: 50%;
	transform: translate(-50%, -50%);
	color: white;
	font-size: 10px;
	font-weight: bold;
}

.agreement-text-mobile {
	flex: 1;
	line-height: 1.4;
}

/* 移动端认证说明文字样式 */
.auth-description-mobile {
	margin: 15px;
	padding: 12px;
	background: #f8f9fa;
	border-radius: 6px;
	border-left: 4px solid #20c997;
}

.auth-description-mobile p {
	margin: 0;
	color: #6c757d;
	font-size: 13px;
	line-height: 1.4;
}

/* 移动端开始认证按钮样式 */
.btn-auth-start-mobile {
	width: 100%;
	padding: 12px 20px;
	font-size: 16px;
	font-weight: 600;
	border-radius: 6px;
	background: #007bff;
	border: 2px solid #007bff;
	color: white;
	transition: all 0.3s ease;
}

/* 移动端活体检测样式 */
.liveness-tips-mobile {
	position: absolute;
	top: 0;
	left: 0;
	right: 0;
	bottom: 0;
	background: rgba(0, 0, 0, 0.8);
	display: flex;
	align-items: center;
	justify-content: center;
	z-index: 10;
	border-radius: 10px;
}

.tip-content-mobile {
	text-align: center;
	color: white;
	padding: 15px;
}

.tip-content-mobile h4 {
	margin-bottom: 15px;
	font-size: 16px;
}

.action-step-mobile {
	margin: 15px 0;
}

.action-icon-mobile {
	font-size: 36px;
	margin-bottom: 8px;
}

.action-text-mobile {
	font-size: 14px;
	font-weight: bold;
}

.progress-bar-mobile {
	width: 150px;
	height: 4px;
	background: rgba(255, 255, 255, 0.3);
	border-radius: 2px;
	margin: 15px auto;
	overflow: hidden;
}

.progress-fill-mobile {
	height: 100%;
	background: #20c997;
	width: 0%;
	transition: width 0.3s ease;
}

.tip-desc-mobile {
	font-size: 12px;
	color: rgba(255, 255, 255, 0.8);
	margin-top: 10px;
}

.face-recognition-area-mobile {
	text-align: center;
	margin: 20px 0;
}

.face-preview-mobile {
	width: 300px;
	height: 200px;
	border: 2px dashed #ddd;
	border-radius: 10px;
	display: flex;
	align-items: center;
	justify-content: center;
	margin: 0 auto;
	background: #f8f9fa;
}

.face-actions-mobile {
	text-align: center;
	margin: 20px 0;
}

.face-actions-mobile .btn {
	margin: 5px;
	display: block;
	width: 100%;
}
</style>

<script type="text/javascript" src="https://o.alicdn.com/yd-cloudauth/cloudauth-cdn/jsvm_all.js" ></script>
<script>
// ------- 步骤控制 -------
let currentStep = 1;
function setStepIndicator(from, to) {
    const fromEl = document.querySelector(`.step-item[data-step="${from}"]`);
    const toEl   = document.querySelector(`.step-item[data-step="${to}"]`);
    if (fromEl) { fromEl.classList.remove('active'); fromEl.classList.add('completed'); }
    if (toEl)   { toEl.classList.add('active'); }
}
function nextStep(targetStep) {
    if (!validateStep(currentStep)) return;
    document.getElementById('step' + currentStep).style.display = 'none';
    document.getElementById('step' + targetStep).style.display = '';
    setStepIndicator(currentStep, targetStep);

    if (targetStep === 2) {
        updateSignatoryInfo(); // 步骤2展示承诺人信息
    } else if (targetStep === 3) {
        updateStep3Summary();  // 步骤3展示摘要
    }
    currentStep = targetStep;
}
function prevStep(targetStep) {
    document.getElementById('step' + currentStep).style.display = 'none';
    document.getElementById('step' + targetStep).style.display = '';
    const curEl = document.querySelector(`.step-item[data-step="${currentStep}"]`);
    const toEl  = document.querySelector(`.step-item[data-step="${targetStep}"]`);
    if (curEl) curEl.classList.remove('active');
    if (toEl)  toEl.classList.add('active');
    currentStep = targetStep;
}

// ------- 签名画布 -------
let signatureData = '';
function initSignature() {
    const canvas = document.getElementById('signatureCanvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    let drawing = false;

    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';

    function pos(e) {
        const rect = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        return {x,y};
    }

    function start(e){ e.preventDefault(); drawing = true; const p = pos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); }
    function move(e){ if(!drawing) return; const p = pos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); }
    function end(){ drawing = false; signatureData = canvas.toDataURL('image/png'); document.getElementById('signatureInput').value = signatureData; }

    canvas.addEventListener('mousedown', start);
    canvas.addEventListener('mousemove', move);
    canvas.addEventListener('mouseup', end);
    canvas.addEventListener('mouseleave', end);

    canvas.addEventListener('touchstart', start, {passive:false});
    canvas.addEventListener('touchmove',  move,  {passive:false});
    canvas.addEventListener('touchend',   end);
}
function clearSignature(){
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width,canvas.height);
    signatureData = '';
    document.getElementById('signatureInput').value = '';
}

// ------- 表单校验 -------
function validateStep(step){
    if (step === 1){
        const name   = document.getElementById('username').value.trim();
        const idcard = document.getElementById('idcard').value.trim();
        const agree1 = document.getElementById('agree_step1').checked;
        if(!name || !idcard){ alert('请填写姓名和身份证号'); return false; }
        const reg = /^(\d{15}$|^\d{18}$|^\d{17}(\d|X|x))$/;
        if(!reg.test(idcard)){ alert('请输入正确的身份证号码'); return false; }
        if(!agree1){ alert('请先勾选同意条款'); return false; }
        return true;
    }
    if (step === 2){
        if(!document.getElementById('agree_terms').checked){ alert('请先同意承诺书'); return false; }
        if(!signatureData){ alert('请在签署区域内手写签名'); return false; }
        return true;
    }
    if (step === 3){
        // 这里验证码按需校验。调试时可以放宽。
        const code = (document.getElementById('verify_code').value||'').trim();
        if (!code || code.length !== 6){ alert('请输入6位验证码'); return false; }
        if(!document.getElementById('agree_final').checked){ alert('请勾选同意协议'); return false; }
        return true;
    }
    return true;
}

// ------- 信息填充 -------
function updateSignatoryInfo(){
    const name   = document.getElementById('username').value.trim();
    const idcard = document.getElementById('idcard').value.trim();
    const now = new Date();
    const dateStr = `${now.getFullYear()}年${String(now.getMonth()+1).padStart(2,'0')}月${String(now.getDate()).padStart(2,'0')}日`;
    document.getElementById('signatory_name').innerText   = name || '待填写';
    document.getElementById('signatory_idcard').innerText = idcard || '待填写';
    document.getElementById('signatory_date').innerText   = dateStr;
}
function maskName(s){ if(!s) return s; return s.length===2 ? s[0]+'*' : s[0] + '*'.repeat(Math.max(0,s.length-2)) + s.slice(-1); }
function maskIdcard(s){ if(!s || s.length<8) return s; return s.slice(0,6) + '********' + s.slice(-4); }
function updateStep3Summary(){
    const name   = document.getElementById('username').value.trim();
    const idcard = document.getElementById('idcard').value.trim();
    document.getElementById('summary_name_step3').innerText   = maskName(name);
    document.getElementById('summary_idcard_step3').innerText = maskIdcard(idcard);
}

// ------- 发送验证码（示例占位） -------
function sendVerifyCode(){
    const btn = document.getElementById('send_code_btn');
    btn.disabled = true;
    let sec = 60;
    const t = setInterval(()=>{
        sec--; btn.innerText = sec + '秒后重发';
        if(sec<=0){ clearInterval(t); btn.disabled=false; btn.innerText='获取验证码'; }
    },1000);
    // TODO: 这里按你的接口调用发送短信
}

// ------- 表单提交：调用后端初始化认证 -------
document.getElementById('simpleAuthForm').addEventListener('submit', async function(e){
    e.preventDefault();

    if (!validateStep(3)) return;

    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = true;
    submitBtn.innerText = '获取认证链接中...';

    const name   = document.getElementById('username').value.trim();
    const idcard = document.getElementById('idcard').value.trim();
    const signature = signatureData || document.getElementById('signatureInput').value || '';
    // 在调用实人认证服务端发起认证请求时需要传入该MetaInfo值
    let MetaInfo = window.getMetaInfo();
    try{
        const res = await fetch('https://www.ssyd.fun/faceauth', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                "metaInfo": MetaInfo,
                "certName": name,
                "certNo": idcard,
                "returnUrl": 'https://www.ssyd.fun/SimpleAuth/faceResult'
            })
        });
        const data = await res.json();
        console.log('faceauth响应:', data);
        
        if (data && data.data && data.data.data && data.data.data.result && data.data.data.result.ResultObject && data.data.data.result.ResultObject.CertifyUrl){
            window.location.href = data.data.data.result.ResultObject.CertifyUrl;
            return;
        }else{
            lastErr = data;
        }
    }catch(ex){
        lastErr = ex;
    }

    // 如果执行到这里说明faceauth调用失败
    const errorMsg = lastErr?.aliyunMessage || lastErr?.msg || lastErr?.message || '未知错误';
    alert('获取认证链接失败：' + errorMsg);
    submitBtn.disabled = false;
    submitBtn.innerText = '开始人脸识别';
});

// ------- 初始化 -------
document.addEventListener('DOMContentLoaded', function(){
    initSignature();
    // 进入页面时把承诺人信息先填一遍（空值则显示“待填写”）
    updateSignatoryInfo();
});
</script>