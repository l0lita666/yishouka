{extend name="layout/member" /} 
{block name="content"}
<div class="view-framework-main">
    {include file="layout/info_menu" /}
    <div class="box tab-content realname-content">
        <div class="alert alert-icon alert-info">
            <div class="icon">
                <i class="iconfont">&#xe61c;</i></div>
            <div class="text">
                <h4>å®åè®¤è¯</h4>
                <p>ä¸ºäº†ä¿éšœæ‚¨çš„è´¦æˆ·å®‰å…¨ï¼Œè¯·å®Œæˆå®åè®¤è¯ã€‚è®¤è¯é€šè¿‡åå¯æ­£å¸¸ä½¿ç”¨å¹³å°åŠŸèƒ½ã€‚</p>
            </div>
        </div>
        
        <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
        <div class="auth-steps">
            <div class="step-item active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-text">å¡«å†™ä¿¡æ¯</div>
            </div>
            <div class="step-item" data-step="2">
                <div class="step-number">2</div>
                <div class="step-text">ç­¾ç½²æ‰¿è¯º222</div>
            </div>
            <div class="step-item" data-step="3">
                <div class="step-number">3</div>
                <div class="step-text">æ„æ„¿è®¤è¯</div>
            </div>
        </div>

        <form id="simpleAuthForm" method="post" action="{:url('home/SimpleAuth/index')}">
            <input type="hidden" name="signature" id="signatureInput" value="">
            <!-- æ­¥éª¤1: å¡«å†™ä¸ªäººä¿¡æ¯ -->
            <div class="auth-step-content" id="step1">
                <div class="userform userform-narrow">
                    <div class="form-group">
                        <label class="form-label" for="username">
                        <em>*</em>çœŸå®å§“åï¼š</label>
                        <div class="form-element">
                            <input type="text" class="form-control" id="username" name="username" value="{$da.name|default=''}" null="è¯·è¾“å…¥çœŸå®å§“å" reg="[\u4e00-\u9fa5]{2,10}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="idcard">
                        <em>*</em>èº«ä»½è¯å·ï¼š</label>
                        <div class="form-element">
                            <input type="text" class="form-control" id="idcard" name="idcard" value="{$da.idcard|default=''}" null="è¯·è¾“å…¥æ­£ç¡®çš„èº«ä»½è¯å·ç " reg="^(\d{15}$|^\d{18}$|^\d{17}(\d|X|x))$">
                        </div>
                    </div>
                    
                    <!-- è¯´æ˜æ–‡å­— -->
                    <div class="auth-description">
                        <p>è¯·è¾“å…¥ä¸æ‚¨çœŸå®çš„å§“åå’Œèº«ä»½è¯å·ï¼Œéœ€è¦é€šè¿‡äººè„¸è¯†åˆ«éªŒè¯æ˜¯å¦ä¸æœ¬äººä¸€è‡´</p>
                    </div>
                    
                    <!-- åŒæ„æ¡æ¬¾ -->
                    <div class="agreement-section">
                        <label class="agreement-checkbox">
                            <input type="checkbox" id="agree_step1" name="agree_step1">
                            <span class="checkmark"></span>
                            <span class="agreement-text">æ‚¨éœ€å¯¹æ³¨å†Œä¿¡æ¯çš„çœŸå®æ€§ã€åˆæ³•æ€§ã€æœ‰æ•ˆæ€§æ‰¿æ‹…å…¨éƒ¨è´£ä»»ï¼›æ˜“æ”¶å¡è´¦æˆ·ä»…é™æœ¬äººä½¿ç”¨ï¼Œä¸å¾—å†’ç”¨ä»–äººä¿¡æ¯è¿›è¡Œæ³¨å†Œï¼Œå¦åˆ™æœ¬å¹³å°æœ‰æƒç«‹å³åœæ­¢å‘æ‚¨æä¾›æœåŠ¡å¹¶ä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©</span>
                        </label>
                    </div>
                    
                    <div class="form-group-btn">
                        <button class="btn btn-primary btn-auth-start" type="button" onclick="nextStep(2)">å¼€å§‹è®¤è¯</button>
                    </div>
                </div>
            </div>

            <!-- æ­¥éª¤2: ç­¾ç½²æ‰¿è¯ºä¹¦ -->
            <div class="auth-step-content" id="step2" style="display:none;">
                <div class="commitment-container">
                    <!-- æ‰¿è¯ºä¹¦å†…å®¹åŒºåŸŸ -->
                    <div class="commitment-document">
                        <div class="document-header">
                            <h4>ç”¨æˆ·æ‰¿è¯ºä¹¦</h4>
                            <div class="document-watermark">Forbidden Copy</div>
                        </div>
                        <div class="document-content">
                            <p class="document-intro">æœ¬äººç¡®è®¤å¹¶æ‰¿è¯ºï¼š</p>
                            <ol class="commitment-list">
                                <li>æœ¬äººè‡ªæ„¿æ³¨å†Œæ˜“æ”¶å¡å¹³å°ï¼Œä¿è¯æä¾›çš„èº«ä»½ä¿¡æ¯çœŸå®ã€å®Œæ•´ï¼Œä¸å­˜åœ¨å†’ç”¨ä»–äººèº«ä»½ä¿¡æ¯çš„æƒ…å†µï¼Œä¸ä¼šå°†æœ¬äººå®åè´¦æˆ·å‡ºç§Ÿã€å‡ºå”®æˆ–å‡ºå€Ÿç»™ä»–äººä½¿ç”¨ã€‚</li>
                                <li>å¦‚ç¬¬ä¸‰æ–¹ï¼ˆåŒ…æ‹¬ä½†ä¸é™äºå¸æ³•æœºå…³ã€è¡Œæ”¿æœºå…³ç­‰ï¼‰å°±æœ¬äººåœ¨æ˜“æ”¶å¡å¹³å°é”€å”®å¡ç‰‡ç›¸å…³äº‹å®œå‘æ˜“æ”¶å¡å¹³å°æŠ•è¯‰æˆ–ä¸¾æŠ¥å­˜åœ¨è¿æ³•è¿è§„è¡Œä¸ºï¼Œæœ¬äººæ‰¿è¯ºç§¯æé…åˆæ˜“æ”¶å¡å¹³å°åŠç›¸å…³éƒ¨é—¨è¿›è¡Œè°ƒæŸ¥ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºæä¾›æœ¬äººèº«ä»½ä¿¡æ¯ã€äº¤æ˜“è®°å½•ç­‰ã€‚</li>
                                <li>æœ¬äººä¿è¯æ‰€é”€å”®çš„æ‰€æœ‰å……å€¼å¡ã€åŠ æ²¹å¡ã€æ¸¸æˆç‚¹å¡ç­‰å¡ç‰‡çš„æ¥æºçœŸå®ã€åˆæ³•ã€åˆè§„ï¼Œå¹¶æ‰¿æ‹…ç›¸åº”çš„æ³•å¾‹è´£ä»»ã€‚</li>
                                <li>æœ¬äººæ‰¿è¯ºä¸ä¼šåˆ©ç”¨æ˜“æ”¶å¡å¹³å°åŠå…¶APIåŠŸèƒ½è¿›è¡Œæ´—é’±ã€æ©é¥°çŠ¯ç½ªæ‰€å¾—ã€ç”µä¿¡è¯ˆéª—ã€ç›—çªƒã€éæ³•å¥—ç°ç­‰è¿æ³•çŠ¯ç½ªæ´»åŠ¨ã€‚</li>
                                <li>æœ¬äººè‡ªæ„¿æ¥å—æ˜“æ”¶å¡å¹³å°åŠç›¸å…³ç›‘ç®¡éƒ¨é—¨çš„ç›‘ç£ã€‚</li>
                                <li>å› æœ¬äººæ‰€å”®å¡ç‰‡å­˜åœ¨è¿æ³•è¿è§„é—®é¢˜å¯¼è‡´çš„ä¸€åˆ‡æŸå¤±æˆ–ä¸è‰¯åæœï¼ˆåŒ…æ‹¬ä½†ä¸é™äºé“¶è¡Œè´¦æˆ·è¢«å†»ç»“ã€ç¬¬ä¸‰æ–¹æŠ•è¯‰ã€æ”¿åºœéƒ¨é—¨è°ƒæŸ¥ã€å¹³å°è¿è¥å—å½±å“ç­‰ï¼‰ï¼Œæœ¬äººæ‰¿æ‹…å…¨éƒ¨æ³•å¾‹è´£ä»»ï¼Œå¹¶åŒæ„å…¨é¢èµ”å¿æ˜“æ”¶å¡å¹³å°å› æ­¤é­å—çš„æ‰€æœ‰æŸå¤±ï¼ˆåŒ…æ‹¬ä½†ä¸é™äºå¹³å°åœæœºæŸå¤±ã€é“¶è¡Œåˆ©æ¯æŸå¤±ã€æ³•å¾‹è´¹ç”¨ã€é…åˆè°ƒæŸ¥äº§ç”Ÿçš„å·®æ—…è´¹ç­‰ï¼‰ã€‚</li>
                            </ol>
                            <p class="document-conclusion">æœ¬äººæˆ–æœ¬å…¬å¸ç¡®è®¤å¹¶çŸ¥æ™“ä»¥ä¸Šå†…å®¹å¹¶ä¿è¯æŒ‰ä¸Šè¿°æ¡æ¬¾æ‰§è¡Œã€‚</p>
                            
                            <!-- æ‰¿è¯ºäººä¿¡æ¯ -->
                            <div class="signatory-info">
                                <div class="signatory-row">
                                    <span class="signatory-label">æ‰¿è¯ºäºº/å…¬å¸ï¼š</span>
                                    <span class="signatory-value" id="signatory_name">å¾…å¡«å†™</span>
                                </div>
                                <div class="signatory-row">
                                    <span class="signatory-label">æ‰¿è¯ºäººèº«ä»½è¯å·ï¼š</span>
                                    <span class="signatory-value" id="signatory_idcard">å¾…å¡«å†™</span>
                                </div>
                                <div class="signatory-row">
                                    <span class="signatory-label">ç­¾ç½²æ—¥æœŸï¼š</span>
                                    <span class="signatory-value" id="signatory_date">å¾…å¡«å†™</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç­¾ç½²åŒºåŸŸ -->
                    <div class="signature-section">
                        <div class="signature-header">
                            <span class="signature-label">ç­¾ç½²åŒºåŸŸ 1/1</span>
                        </div>
                        <div class="signature-container">
                            <canvas id="signatureCanvas" width="400" height="200"></canvas>
                        </div>
                        <div class="signature-actions">
                            <button type="button" class="btn btn-outline-secondary" onclick="clearSignature()">æ¸…é™¤é‡ç­¾</button>
                        </div>
                    </div>
                    
                    <!-- åŒæ„æ¡æ¬¾ -->
                    <div class="agreement-section">
                        <label class="agreement-checkbox">
                            <input type="checkbox" id="agree_terms" name="agree_terms">
                            <span class="checkmark"></span>
                            <span class="agreement-text">æˆ‘å·²é˜…è¯»å¹¶åŒæ„ä¸Šè¿°æ‰¿è¯ºä¹¦å†…å®¹</span>
                        </label>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="action-buttons">
                        <button class="btn btn-outline-primary" type="button" onclick="prevStep(1)">ä¸Šä¸€æ­¥</button>
                        <button class="btn btn-primary" type="button" onclick="nextStep(3)">ç¡®è®¤ç­¾ç½²</button>
                    </div>
                </div>
            </div>

            <!-- æ­¥éª¤3: æ‰‹æœºéªŒè¯å’Œäººè„¸è¯†åˆ« -->
            <div class="auth-step-content" id="step3" style="display:none;">
                <div class="userform userform-narrow">
                    <!-- ä¸ªäººä¿¡æ¯ç¡®è®¤ -->
                    <div class="personal-info-section">
                        <div class="info-title">è¯·ç¡®è®¤æ‚¨çš„ä¸ªäººä¿¡æ¯</div>
                        <div class="info-card">
                            <div class="info-item">
                                <span class="info-label">è¯ä»¶ç±»å‹ï¼š</span>
                                <span class="info-value">å±…æ°‘èº«ä»½è¯</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">å§“åï¼š</span>
                                <span class="info-value" id="summary_name_step3"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">è¯ä»¶å·ï¼š</span>
                                <span class="info-value" id="summary_idcard_step3"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">æ‰‹æœºå·ï¼š</span>
                                <span class="info-value" id="summary_mobile_step3">{$user.mobile_masked|default=''}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ‰‹æœºéªŒè¯ç  -->
                    <div class="form-group verify-code-section">
                        <label class="form-label" for="verify_code">
                        <em>*</em>éªŒè¯ç ï¼š</label>
                        <div class="verify-code-input">
                            <input type="text" class="form-control" id="verify_code" name="verify_code" null="è¯·è¾“å…¥éªŒè¯ç " reg="[0-9]{6}" placeholder="è¯·è¾“å…¥6ä½éªŒè¯ç ">
                            <button type="button" class="get-code-btn" onclick="sendVerifyCode()" id="send_code_btn">è·å–éªŒè¯ç </button>
                        </div>
                    </div>
                    
                    <!-- åŒæ„æ¡æ¬¾ -->
                    <div class="agreement-section">
                        <label class="agreement-checkbox">
                            <input type="checkbox" id="agree_final" name="agree_final">
                            <span class="checkmark"></span>
                            <span class="agreement-text">æˆ‘å·²é˜…è¯»å¹¶åŒæ„ã€Šæ˜“æ”¶å¡ç”¨æˆ·åè®®ã€‹ã€ã€Šæ˜“æ”¶å¡éšç§æ”¿ç­–ã€‹åŠã€Šç¬¬ä¸‰æ–¹ä¸ªäººä¿¡æ¯å…±äº«æ¸…å•ã€‹ï¼Œå¹¶å·²äº†è§£ç›¸å…³æ•°æ®ä¼šè¢«ä¼ è¾“è‡³æœåŠ¡å™¨ä¸­</span>
                        </label>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="form-group-btn">
                        <button class="btn btn-default" type="button" onclick="prevStep(2)">ä¸Šä¸€æ­¥</button>
                        {:token_field()}
                        <button class="btn btn-success btn-large" type="submit" name="submitAuth" id="submit-btn">å¼€å§‹äººè„¸è¯†åˆ«</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<style>
.auth-steps {
    display: flex;
    justify-content: space-between;
    margin-bottom: 30px;
    padding: 20px 0;
}

.step-item {
    flex: 1;
    text-align: center;
    position: relative;
}

.step-item:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 20px;
    right: -50%;
    width: 100%;
    height: 2px;
    background: #e9ecef;
    z-index: 1;
}

.step-item.active:not(:last-child)::after {
    background: #007bff;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
    font-weight: bold;
    position: relative;
    z-index: 2;
}

.step-item.active .step-number {
    background: #007bff;
    color: white;
}

.step-item.completed .step-number {
    background: #28a745;
    color: white;
}

.step-text {
    font-size: 14px;
    color: #6c757d;
}

.step-item.active .step-text {
    color: #007bff;
    font-weight: bold;
}

.commitment-content {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #e9ecef;
    padding: 20px;
    border-radius: 5px;
    background: #f8f9fa;
}

.commitment-text {
    line-height: 1.6;
    font-size: 14px;
}

.commitment-text ol {
    padding-left: 20px;
}

/* æ‰¿è¯ºä¹¦å®¹å™¨æ ·å¼ */
.commitment-container {
    max-width: 800px;
    margin: 0 auto;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    overflow: hidden;
}

/* æ‰¿è¯ºä¹¦æ–‡æ¡£æ ·å¼ */
.commitment-document {
    position: relative;
    padding: 30px;
    background: #fff;
    border-bottom: 1px solid #e9ecef;
}

.document-header {
    text-align: center;
    margin-bottom: 30px;
    position: relative;
}

.document-header h4 {
    font-size: 24px;
    font-weight: 600;
    color: #333;
    margin: 0;
}

.document-watermark {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-45deg);
    font-size: 48px;
    color: rgba(0,0,0,0.05);
    font-weight: bold;
    pointer-events: none;
    z-index: 1;
}

.document-content {
    position: relative;
    z-index: 2;
    line-height: 1.8;
    color: #333;
}

.document-intro {
    font-weight: 600;
    margin-bottom: 20px;
    color: #333;
}

.commitment-list {
    margin: 20px 0;
    padding-left: 20px;
}

.commitment-list li {
    margin-bottom: 15px;
    line-height: 1.6;
    color: #555;
}

.document-conclusion {
    margin-top: 30px;
    font-weight: 600;
    text-align: center;
    color: #333;
}

/* ç­¾ç½²åŒºåŸŸæ ·å¼ */
.signature-section {
    padding: 30px;
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
}

.signature-header {
    margin-bottom: 20px;
}

.signature-label {
    font-size: 14px;
    color: #6c757d;
    background: #e9ecef;
    padding: 8px 16px;
    border-radius: 4px;
    display: inline-block;
}

.signature-container {
    position: relative;
    text-align: center;
    background: #fff;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

#signatureCanvas {
    border: none;
    cursor: crosshair;
    background: #fff;
    border-radius: 4px;
}


.signature-actions {
    text-align: center;
}

/* æ‰¿è¯ºäººä¿¡æ¯æ ·å¼ */
.signatory-info {
    margin-top: 30px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.signatory-row {
    display: flex;
    margin-bottom: 12px;
    align-items: center;
}

.signatory-row:last-child {
    margin-bottom: 0;
}

.signatory-label {
    font-weight: 600;
    color: #333;
    min-width: 140px;
    margin-right: 10px;
}

.signatory-value {
    color: #555;
    flex: 1;
}

/* åŒæ„æ¡æ¬¾æ ·å¼ */
.agreement-section {
    padding: 20px 30px;
    background: #fff;
    border-bottom: 1px solid #e9ecef;
    margin-top: 20px;
}

.agreement-checkbox {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-size: 14px;
    color: #333;
}

.agreement-checkbox input[type="checkbox"] {
    display: none;
}

.checkmark {
    width: 20px;
    height: 20px;
    border: 2px solid #dee2e6;
    border-radius: 4px;
    margin-right: 12px;
    position: relative;
    transition: all 0.3s ease;
}

.agreement-checkbox input[type="checkbox"]:checked + .checkmark {
    background: #20c997;
    border-color: #20c997;
}

.agreement-checkbox input[type="checkbox"]:checked + .checkmark::after {
    content: 'âœ“';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 12px;
    font-weight: bold;
}

.agreement-text {
    flex: 1;
    line-height: 1.5;
}

/* è®¤è¯è¯´æ˜æ–‡å­—æ ·å¼ */
.auth-description {
    margin: 20px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
    border-left: 4px solid #20c997;
}

.auth-description p {
    margin: 0;
    color: #6c757d;
    font-size: 14px;
    line-height: 1.5;
}

/* æ“ä½œæŒ‰é’®æ ·å¼ */
.action-buttons {
    padding: 20px 30px;
    background: #f8f9fa;
    display: flex;
    gap: 15px;
    justify-content: center;
}

/* å¼€å§‹è®¤è¯æŒ‰é’®æ ·å¼ */
.btn-auth-start {
    width: 100%;
    padding: 15px 30px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 8px;
    background: #007bff;
    border: 2px solid #007bff;
    color: white;
    transition: all 0.3s ease;
}

.btn-auth-start:hover {
    background: #0056b3;
    border-color: #0056b3;
}

.action-buttons .btn {
    min-width: 120px;
    padding: 12px 24px;
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-outline-primary {
    border: 2px solid #007bff;
    color: #007bff;
    background: transparent;
}

.btn-outline-primary:hover {
    background: #007bff;
    color: white;
}

.btn-primary {
    background: #20c997;
    border: 2px solid #20c997;
    color: white;
}

.btn-primary:hover {
    background: #1ba085;
    border-color: #1ba085;
}

.btn-outline-secondary {
    border: 2px solid #6c757d;
    color: #6c757d;
    background: transparent;
}

/* æ´»ä½“æ£€æµ‹æ ·å¼ */
.liveness-tips {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
}

.tip-content {
    text-align: center;
    color: white;
    padding: 20px;
}

.tip-content h4 {
    margin-bottom: 20px;
    font-size: 18px;
}

.action-step {
    margin: 20px 0;
}

.action-icon {
    font-size: 48px;
    margin-bottom: 10px;
}

.action-text {
    font-size: 16px;
    font-weight: bold;
}

.progress-bar {
    width: 200px;
    height: 6px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
    margin: 20px auto;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: #20c997;
    width: 0%;
    transition: width 0.3s ease;
}

.tip-desc {
    font-size: 14px;
    color: rgba(255, 255, 255, 0.8);
    margin-top: 15px;
}

.auth-summary {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 5px;
    margin: 20px 0;
    text-align: left;
}

.auth-summary p {
    margin-bottom: 10px;
    font-size: 16px;
}

.success-icon {
    margin-bottom: 20px;
}

.info-summary {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin: 10px 0;
}

.info-summary p {
    margin-bottom: 8px;
    font-size: 16px;
}

/* ä¸ªäººä¿¡æ¯ç¡®è®¤åŒºåŸŸæ ·å¼ */
.personal-info-section {
    margin: 20px 0;
}

.info-title {
    font-size: 18px;
    font-weight: 600;
    color: #333;
    margin-bottom: 15px;
    text-align: center;
}

.info-card {
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
    font-size: 16px;
}

.info-item:last-child {
    border-bottom: none;
}

.info-label {
    font-weight: 500;
    color: #666;
    min-width: 100px;
}

.info-value {
    color: #333;
    flex: 1;
    text-align: right;
    font-weight: 500;
}

/* éªŒè¯ç åŒºåŸŸæ ·å¼ */
.verify-code-section {
    margin: 20px 0;
}

.verify-code-input {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.verify-code-input input {
    flex: 1;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 16px;
}

.get-code-btn {
    background: #007bff;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    white-space: nowrap;
}

.get-code-btn:hover {
    background: #0056b3;
}

/* åè®®åŒºåŸŸæ ·å¼ */
.agreement-section {
    margin: 25px 0;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.agreement-checkbox {
    display: flex;
    align-items: flex-start;
    cursor: pointer;
    color: #333;
    line-height: 1.6;
}

.agreement-checkbox input[type="checkbox"] {
    margin-right: 12px;
    margin-top: 3px;
    transform: scale(1.2);
}

.agreement-text {
    font-size: 14px;
    color: #666;
    flex: 1;
}

/* æŒ‰é’®åŒºåŸŸæ ·å¼ */
.form-group-btn {
    margin-top: 30px;
    display: flex;
    gap: 15px;
}

.form-group-btn .btn {
    flex: 1;
    padding: 15px 20px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-default {
    background: #f8f9fa;
    color: #6c757d;
    border: 1px solid #dee2e6;
}

.btn-default:hover {
    background: #e9ecef;
    color: #495057;
}

.btn-success {
    background: linear-gradient(to right, #0085fe 0%, #5c4bf6 100%);
    color: white;
}

.btn-success:hover {
    background: linear-gradient(to right, #0085fe 0%, #5c4bf6 100%);
}

.btn-large {
    padding: 18px 25px;
    font-size: 18px;
}

.face-recognition-area {
    text-align: center;
    margin: 20px 0;
}

.face-preview {
    width: 400px;
    height: 300px;
    border: 2px dashed #ddd;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    background: #f8f9fa;
}

.face-guide {
    text-align: center;
    color: #6c757d;
}

.face-actions {
    text-align: center;
    margin: 20px 0;
}

.face-actions .btn {
    margin: 0 10px;
}
</style>
<script type="text/javascript" src="https://o.alicdn.com/yd-cloudauth/cloudauth-cdn/jsvm_all.js" ></script>
<script>
let currentStep = 1;
let signatureData = '';

// åˆå§‹åŒ–ç­¾åç”»å¸ƒ
function initSignature() {
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;

    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    
    // è§¦æ‘¸äº‹ä»¶æ”¯æŒ
    canvas.addEventListener('touchstart', handleTouch);
    canvas.addEventListener('touchmove', handleTouch);
    canvas.addEventListener('touchend', stopDrawing);

    function startDrawing(e) {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        ctx.beginPath();
        ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    function draw(e) {
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
        ctx.stroke();
    }

    function stopDrawing() {
        isDrawing = false;
        signatureData = canvas.toDataURL();
    }
    
    function handleTouch(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                          e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    }
}

function nextStep(step) {
    if (validateCurrentStep()) {
        if (step === 2) {
            // æ­¥éª¤2ï¼šç­¾ç½²æ‰¿è¯ºä¹¦ï¼Œæ›´æ–°æ‰¿è¯ºäººä¿¡æ¯
            updateSignatoryInfo();
        } else if (step === 3) {
            // æ­¥éª¤3ï¼šæ‰‹æœºéªŒè¯ï¼Œæ˜¾ç¤ºä¸ªäººä¿¡æ¯æ‘˜è¦
            updateStep3Summary();
            updateSignatoryInfo();
        } else if (step === 4) {
            // æ­¥éª¤4ï¼šäººè„¸è¯†åˆ«ï¼Œæ˜¾ç¤ºå®Œæ•´ä¿¡æ¯æ‘˜è¦
            updateSummary();
        }
        
        document.getElementById('step' + currentStep).style.display = 'none';
        document.getElementById('step' + step).style.display = 'block';
        
        // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
        document.querySelector(`[data-step="${currentStep}"]`).classList.remove('active');
        document.querySelector(`[data-step="${currentStep}"]`).classList.add('completed');
        document.querySelector(`[data-step="${step}"]`).classList.add('active');
        
        currentStep = step;
    }
}

function prevStep(step) {
    document.getElementById('step' + currentStep).style.display = 'none';
    document.getElementById('step' + step).style.display = 'block';
    
    // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
    document.querySelector(`[data-step="${currentStep}"]`).classList.remove('active');
    document.querySelector(`[data-step="${step}"]`).classList.add('active');
    
    currentStep = step;
}

function validateCurrentStep() {
    if (currentStep === 1) {
        const username = document.getElementById('username').value;
        const idcard = document.getElementById('idcard').value;
        const agreeStep1 = document.getElementById('agree_step1').checked;
        
        if (!username || !idcard) {
            alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
            return false;
        }
        
        // ç®€å•çš„èº«ä»½è¯éªŒè¯
        const idcardReg = /^(\d{15}$|^\d{18}$|^\d{17}(\d|X|x))$/;
        if (!idcardReg.test(idcard)) {
            alert('è¯·è¾“å…¥æ­£ç¡®çš„èº«ä»½è¯å·ç ');
            return false;
        }
        
        if (!agreeStep1) {
            alert('è¯·å…ˆåŒæ„ç›¸å…³æ¡æ¬¾');
            return false;
        }
    } else if (currentStep === 2) {
        if (!document.getElementById('agree_terms').checked) {
            alert('è¯·å…ˆåŒæ„æ‰¿è¯ºä¹¦å†…å®¹');
            return false;
        }
        
        if (!signatureData) {
            alert('è¯·è¿›è¡Œç”µå­ç­¾å');
            return false;
        }
    } else if (currentStep === 3) {
        const mobile = document.getElementById('mobile').value;
        const verifyCode = document.getElementById('verify_code').value;
        
        if (!mobile) {
            alert('è¯·è¾“å…¥æ‰‹æœºå·ç ');
            return false;
        }
        
        // æ‰‹æœºå·éªŒè¯
        const mobileReg = /^1[3-9]\d{9}$/;
        if (!mobileReg.test(mobile)) {
            alert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ');
            return false;
        }
        
        if (!verifyCode || verifyCode.length !== 6) {
            alert('è¯·è¾“å…¥6ä½éªŒè¯ç ');
            return false;
        }
    }
    
    return true;
}

function sendVerifyCode() {
    const mobile = document.getElementById('mobile').value;
    const btn = document.getElementById('send_code_btn');
    
    // è¿™é‡Œåº”è¯¥è°ƒç”¨å‘é€éªŒè¯ç çš„API
    // æš‚æ—¶æ¨¡æ‹Ÿå‘é€æˆåŠŸ
    btn.textContent = '60ç§’åé‡å‘';
    btn.disabled = true;
    
    let countdown = 60;
    const timer = setInterval(() => {
        countdown--;
        btn.textContent = countdown + 'ç§’åé‡å‘';
        
        if (countdown <= 0) {
            clearInterval(timer);
            btn.textContent = 'é‡æ–°è·å–';
            btn.disabled = false;
        }
    }, 1000);
}

function clearSignature() {
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    signatureData = '';
}

function updateStep3Summary() {
    const username = document.getElementById('username').value;
    const idcard = document.getElementById('idcard').value;
    
    // å§“åéšç§ä¿æŠ¤
    const maskedName = maskName(username);
    document.getElementById('summary_name_step3').textContent = maskedName;
    
    // èº«ä»½è¯å·éšç§ä¿æŠ¤
    const maskedIdCard = maskIdCard(idcard);
    document.getElementById('summary_idcard_step3').textContent = maskedIdCard;
    
    // æ‰‹æœºå·ç›´æ¥ä»æ¨¡æ¿è·å–ï¼Œä¸éœ€è¦åŠ¨æ€æ›´æ–°
}

// å§“åéšç§ä¿æŠ¤
function maskName(name) {
    if (!name || name.length < 2) {
        return name;
    }
    if (name.length === 2) {
        return name.charAt(0) + '*';
    } else {
        return name.charAt(0) + '*'.repeat(name.length - 2) + name.charAt(name.length - 1);
    }
}

// èº«ä»½è¯å·éšç§ä¿æŠ¤
function maskIdCard(idcard) {
    if (!idcard || idcard.length < 8) {
        return idcard;
    }
    return idcard.substring(0, 6) + '********' + idcard.substring(idcard.length - 4);
}

// æ›´æ–°æ‰¿è¯ºäººä¿¡æ¯
function updateSignatoryInfo() {
    const username = document.getElementById('username').value;
    const idcard = document.getElementById('idcard').value;
    
    // è·å–å½“å‰æ—¥æœŸï¼Œæ ¼å¼ï¼š2024å¹´12æœˆ19æ—¥
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const currentDate = `${year}å¹´${month}æœˆ${day}æ—¥`;
    
    // æ›´æ–°æ‰¿è¯ºäººä¿¡æ¯
    document.getElementById('signatory_name').textContent = username || 'å¾…å¡«å†™';
    document.getElementById('signatory_idcard').textContent = idcard || 'å¾…å¡«å†™';
    document.getElementById('signatory_date').textContent = currentDate;
}

function updateSummary() {
    document.getElementById('summary_name').textContent = document.getElementById('username').value;
    document.getElementById('summary_idcard').textContent = document.getElementById('idcard').value;
    document.getElementById('summary_mobile').textContent = document.getElementById('mobile').value;
}

// äººè„¸è¯†åˆ«ç›¸å…³å‡½æ•°
let stream = null;
let faceImageData = '';
let currentAction = 0;
let livenessActions = [
    { icon: 'ğŸ‘ï¸', text: 'è¯·çœ¨çœ¼', duration: 3000 },
    { icon: 'â†”ï¸', text: 'è¯·æ‘‡å¤´', duration: 3000 },
    { icon: 'ğŸ˜®', text: 'è¯·å¼ å˜´', duration: 3000 }
];

function startFaceRecognition() {
    const video = document.getElementById('video');
    const facePreview = document.getElementById('face-preview');
    const startBtn = document.getElementById('start-face-btn');
    const captureBtn = document.getElementById('capture-btn');
    
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(function(mediaStream) {
            stream = mediaStream;
            video.srcObject = stream;
            video.style.display = 'block';
            facePreview.style.display = 'none';
            startBtn.style.display = 'none';
            
            // å¼€å§‹æ´»ä½“æ£€æµ‹æµç¨‹
            startLivenessDetection();
        })
        .catch(function(err) {
            alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
            console.error('æ‘„åƒå¤´è®¿é—®é”™è¯¯:', err);
        });
}

function startLivenessDetection() {
    // æ˜¾ç¤ºæ´»ä½“æ£€æµ‹æç¤º
    document.getElementById('liveness-tips').style.display = 'flex';
    
    // å¼€å§‹ç¬¬ä¸€ä¸ªåŠ¨ä½œ
    performLivenessAction(0);
}

function performLivenessAction(actionIndex) {
    if (actionIndex >= livenessActions.length) {
        // æ‰€æœ‰åŠ¨ä½œå®Œæˆï¼Œå¯ä»¥æ‹ç…§
        completeLivenessDetection();
        return;
    }
    
    const action = livenessActions[actionIndex];
    const actionStep = document.getElementById('action-step');
    const progressFill = document.getElementById('progress-fill');
    
    // æ›´æ–°åŠ¨ä½œæç¤º
    actionStep.innerHTML = `
        <div class="action-icon">${action.icon}</div>
        <div class="action-text">${action.text}</div>
    `;
    
    // é‡ç½®è¿›åº¦æ¡
    progressFill.style.width = '0%';
    
    // å¼€å§‹è¿›åº¦åŠ¨ç”»
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += 2;
        progressFill.style.width = progress + '%';
        
        if (progress >= 100) {
            clearInterval(progressInterval);
            // å½“å‰åŠ¨ä½œå®Œæˆï¼Œè¿›è¡Œä¸‹ä¸€ä¸ª
            setTimeout(() => {
                performLivenessAction(actionIndex + 1);
            }, 500);
        }
    }, action.duration / 50);
}

function completeLivenessDetection() {
    // éšè—æ´»ä½“æ£€æµ‹æç¤º
    document.getElementById('liveness-tips').style.display = 'none';
    
    // æ˜¾ç¤ºæ‹ç…§æŒ‰é’®
    document.getElementById('capture-btn').style.display = 'inline-block';
}

function captureFace() {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    // ç»˜åˆ¶å½“å‰è§†é¢‘å¸§åˆ°canvas
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // è·å–å›¾åƒæ•°æ®
    faceImageData = canvas.toDataURL('image/jpeg', 0.8);
    
    // åœæ­¢æ‘„åƒå¤´
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
    
    // æ˜¾ç¤ºæ•è·çš„å›¾åƒ
    const facePreview = document.getElementById('face-preview');
    facePreview.innerHTML = '<img src="' + faceImageData + '" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">';
    facePreview.style.display = 'flex';
    
    // éšè—è§†é¢‘ï¼Œæ˜¾ç¤ºæŒ‰é’®
    video.style.display = 'none';
    document.getElementById('capture-btn').style.display = 'none';
    document.getElementById('retry-btn').style.display = 'inline-block';
    document.getElementById('submit-btn').style.display = 'inline-block';
}

function retryFaceRecognition() {
    // é‡ç½®çŠ¶æ€
    faceImageData = '';
    document.getElementById('face-preview').innerHTML = `
        <div class="face-guide">
            <i class="iconfont" style="font-size: 48px; color: #007bff;">&#xe61c;</i>
            <p>ç‚¹å‡»å¼€å§‹äººè„¸è¯†åˆ«</p>
        </div>
    `;
    document.getElementById('retry-btn').style.display = 'none';
    document.getElementById('submit-btn').style.display = 'none';
    document.getElementById('start-face-btn').style.display = 'inline-block';
}

// éªŒè¯æ‰€æœ‰æ­¥éª¤
function validateAllSteps() {
    // æš‚æ—¶ç®€åŒ–éªŒè¯ï¼Œæ€»æ˜¯è¿”å›true
    console.log('validateAllSteps: è·³è¿‡éªŒè¯ï¼Œç›´æ¥è¿”å›true');
    return true;
    
    // éªŒè¯æ­¥éª¤1
    const username = document.getElementById('username').value;
    const idcard = document.getElementById('idcard').value;
    const agreeStep1 = document.getElementById('agree_step1').checked;
    
    if (!username || !idcard) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return false;
    }
    
    // ç®€å•çš„èº«ä»½è¯éªŒè¯
    const idcardReg = /^(\d{15}$|^\d{18}$|^\d{17}(\d|X|x))$/;
    if (!idcardReg.test(idcard)) {
        alert('è¯·è¾“å…¥æ­£ç¡®çš„èº«ä»½è¯å·ç ');
        return false;
    }
    
    if (!agreeStep1) {
        alert('è¯·å…ˆåŒæ„ç›¸å…³æ¡æ¬¾');
        return false;
    }
    
    // éªŒè¯æ­¥éª¤2
    if (!document.getElementById('agree_terms').checked) {
        alert('è¯·å…ˆåŒæ„æ‰¿è¯ºä¹¦å†…å®¹');
        return false;
    }
    
    if (!signatureData) {
        alert('è¯·è¿›è¡Œç”µå­ç­¾å');
        return false;
    }
    
    // éªŒè¯æ­¥éª¤3
    const mobile = document.getElementById('mobile').value;
    const verifyCode = document.getElementById('verify_code').value;
    
    if (!mobile) {
        alert('è¯·è¾“å…¥æ‰‹æœºå·ç ');
        return false;
    }
    
    // æ‰‹æœºå·éªŒè¯
    const mobileReg = /^1[3-9]\d{9}$/;
    if (!mobileReg.test(mobile)) {
        alert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ');
        return false;
    }
    
    if (!verifyCode || verifyCode.length !== 6) {
        // æš‚æ—¶è·³è¿‡éªŒè¯ç æ ¡éªŒ
        // alert('è¯·è¾“å…¥6ä½éªŒè¯ç ');
        // return false;
    }
    
    return true;
}

// è¡¨å•æäº¤å¤„ç† - ä¸ç§»åŠ¨ç«¯ä¿æŒä¸€è‡´
document.getElementById('simpleAuthForm').addEventListener('submit', async function(e) {
    e.preventDefault(); // é˜»æ­¢é»˜è®¤æäº¤
    
    // éªŒè¯æ‰€æœ‰æ­¥éª¤
    if (!validateAllSteps()) {
        return false;
    }
    
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = true;
    submitBtn.innerText = 'è·å–è®¤è¯é“¾æ¥ä¸­...';
    
    // ç›´æ¥å¼€å§‹äººè„¸è¯†åˆ«
    await startFaceVerification();
});

// å¼€å§‹äººè„¸è¯†åˆ« - ä¸ç§»åŠ¨ç«¯ä¿æŒä¸€è‡´çš„é€»è¾‘
async function startFaceVerification() {
    // è·å–è¡¨å•æ•°æ®
    const username = document.getElementById('username').value.trim();
    const idcard = document.getElementById('idcard').value.trim();
    
    // åœ¨è°ƒç”¨å®äººè®¤è¯æœåŠ¡ç«¯å‘èµ·è®¤è¯è¯·æ±‚æ—¶éœ€è¦ä¼ å…¥è¯¥MetaInfoå€¼
    let MetaInfo = window.getMetaInfo();
    MetaInfo.deviceType = 'h5';
    // console.log('MetaInfo:', MetaInfo);
    // return;
    let lastErr = null;
    
    try {
        const res = await fetch('https://www.ssyd.fun/faceauth', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                "metaInfo": MetaInfo,
                "certName": username,
                "certNo": idcard,
                "returnUrl": 'https://www.ssyd.fun/SimpleAuth/faceResult'
            })
        });
        const data = await res.json();
        console.log('faceauthå“åº”:', data);
        
        if (data && data.data && data.data.data && data.data.data.result && data.data.data.result.ResultObject && data.data.data.result.ResultObject.CertifyUrl){
            window.location.href = data.data.data.result.ResultObject.CertifyUrl;
            return;
        }else{
            lastErr = data;
        }
    }catch(ex){
        lastErr = ex;
    }

    // å¦‚æœæ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜faceauthè°ƒç”¨å¤±è´¥
    const errorMsg = lastErr?.aliyunMessage || lastErr?.msg || lastErr?.message || 'æœªçŸ¥é”™è¯¯';
    alert('è·å–è®¤è¯é“¾æ¥å¤±è´¥ï¼š' + errorMsg);
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = false;
    submitBtn.innerText = 'å¼€å§‹äººè„¸è¯†åˆ«';
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ç­¾ååŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    initSignature();
});
</script>
{/block}
